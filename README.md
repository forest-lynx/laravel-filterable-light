# Фильтрация для моделей Laravel
[![Software License][ico-license]](LICENSE)

[![Laravel][ico-laravel]](Laravel) [![PHP][ico-php]](PHP) [![PHP][ico-mysql]](Mysql)

Пакет представляет собой удобный инструмент для добавления метода фильтрации к моделям Eloquent в Laravel. При помощи этого пакета можно легко преобразовывать запросы к базе данных на основе данных, полученных от пользователя.
Особенность этого пакета заключается в генерации параметров фильтрации на основе структуры модели и схемы соответствующей таблицы в базе данных. Пакет анализирует поля модели, ключи полнотекстового поиска и связи с другими таблицами, чтобы обеспечить максимально удобный процесс фильтрации данных.

## Table of Contents

* [Установка](#установка)
* [Настройка](#настройка)
* [Генерация фильтров](#генерация-фильтров)
* [Применение](#применение)
* [Лицензия](#лицензия)


## Установка

Вы можете просто загрузить или клонировать этот репозиторий, а также установить его через [Composer](https://getcomposer.org)

Команда для установки:

```bash
$ composer require forest-lynx/laravel-filterable
```

## Настройка

Если необходимо опубликуйте файла конфигурации выполнив команду:
```bash
$ php artisan vendor:publish --tag=filterable-config
```
Или вы можете осуществить настройку переменных пакета в вашем конфигурационном файле (`.env`).

Описание настроек:

`FILTERABLE_MODELS_PATH` Отвечает за пространство имен моделей. По умолчанию "`App\\Models\\`"

`FILTERABLE_DISK` Отвечает за путь к папке для хранения сгенерированных файлов, допустимых условий фильтрации модели. По умолчанию используется `disk`: `local` из файла настройки файловой системы вашего приложения `filesystems.php`. Вы можете создать новый диск в указанном файле для сохранения сгенерированных файлов.
> Помните, что созданный диск не желательно делать публичным.

`FILTERABLE_SKIP_TABLES` Массив таблиц не участвующих в фильтрации

`FILTERABLE_SKIP_COLUMNS` Массив колонок не участвующих в фильтрации
> Применятся ко всем моделям. Так же из моделей исключаются поля отвечающие за связи с другими таблицами. Исключение таких полей происходит из принципов конвенции наименований применяемых в Laravel.

`FILTERABLE_GET_FROM_DATABASE` Получать ли сведения о таблицах и полях из базы данных при генерации фильтров (комментариев, информации о полях, полнотекстовом поиске).

Добавьте `Trait` в модели для которых планируется применение фильтрации:
```php
//...
use ForestLynx\Filterable\Console\Commands;

class Card extends Model{
    use HasFilterable;
}
```
У модели становятся доступны свойства:

```php
//...
    protected $filtering = true;
    protected $filtering_fields = [];
//...
```
Свойство `$filtering` (логическое значение) отвечает за применение к модели фильтрации, а так же генерацию допустимых условий фильтрации. По умолчанию `true`. Свойство может быть не объявлено в модели.

Свойство `$filtering_fields` массив полей участвующих в фильтрации, имеет вид `["имя_поля" => "комментарий"]`. Свойство может быть не объявлено в модели, в таком случае сведения о полях доступных для фильтрации берутся из свойства `$fillable` указанных для модели.

В пакете применяются `Attribute` для дополнительной настройки модели.
Для модели и методов допустимо применение аттрибута `CommentAttribute` с единственно допустимым параметром `comment` (строка) - комментарий к модели. Не обязательный параметр.
```php
//...
use ForestLynx\Filterable\Attributes\CommentAttribute;

#[CommentAttribute('Модель продукты, определяет свойства продукта')]
class Product extends Model{
    use HasFilterable;
    //...
    #[CommentAttribute('Получение сведений о стоимости продукта.')]
    public function price(): HasOne
    {
    //...
```
Для методов участвующих в связях с другими моделями так же возможно применение атрибута `MethodAttributes` с параметрами: `comment` (строка) - комментарий к методу, `filtering_allowed` (логическое, по умолчанию `true`)  - разрешена ли фильтрация. Оба параметра не обязательны.
Примеры использования:
```php
//...
use ForestLynx\Filterable\Attributes\MethodAttributes;

class Product extends Model{
    use HasFilterable;
    //...
    #[MethodAttributes('Получение сведений о стоимости продукта.',false)]
    public function price(): HasOne
    {

    #[MethodAttributes('Получение сведений о стоимости продукта.')]
    public function properties(): HasMany
    {

    #[MethodAttributes(filtering_allowed: false)]
    public function tags(): BelongsToMany
    {
    //...
```
При присвоении параметру `filtering_allowed` значения `false` аттрибута `MethodAttributes` данная связь где применен аттрибут, будет исключена из допустимых условий фильтрации, при генерации и последующее фильтрации.
>В случае если вы ранее сгенерировали данные для условий фильтрации, и затем внесли корректировку в модели связанную с допустимыми условиями, вам необходимо повторно сгенерировать данные для модели [см. Генерация фильтров](#генерация-фильтров)

## Генерация фильтров

Для запуска генерации доступных условий фильтрации у моделей выполните команду:

```bash
php artisan filterable:build
```
> при отсутствии аргументов, будет произведена генерация для всех моделей находящихся в каталоге из настроек `FILTERABLE_MODELS_PATH`

Аргумент: Имя/имена модели(ей) (имена моделей можно указывать как в верхнем так и нижнем регистре) для которых необходимо сгенерировать допустимые фильтры. 

Примеры:
```bash
php artisan filterable:build Tag
php artisan filterable:build post Client
```
Вы так же можете указать имена таблиц:
```bash
php artisan filterable:build cards failed_cards
```
Опция: `--r|rebuild` при указании данной опции будет произведена новая генерация данных условий фильтрации, с удалением ранее созданных данных.
> Важно! Сведения о связях с другими моделями определяются по типу возвращаемого значения, которое должно соответствовать `Illuminate\Database\Eloquent\Relations`

## Применение

После объявления `Trait` у модели, и генерации доступных условий для фильтрации, доступен метод `filter(array $filters)`:
```php
//...
    Card::filter(`$filters`);
//...
```
Параметр метода должен принимать массив вида:
```php
[
    //свойства модели по которым допустима фильтрация
    'name' => '=:пирожок',  //1.тип операции сравнения формирования поискового запроса (до:)
                            //2. искомое(ый) значение(я)
    ...
    //для свойств допустима группировка на выходе запрос where (description ... AND amount ...) 
    0 => [
        'description' => '~:Описание пирожка',
        'amount' => '!=:10'
    ],
    //связь с другими моделями
    'related' => [ 
        //имя связи
        'properties' =>
        [
            //свойства у связанной модели по которым допустима фильтрация
            'amount': '><:52&75',
            ...
        ],
        ...
    ],
    //полнотекстовый поиск
    'fulltext' => [
        //название ключа полнотекстового поиска
        "ft_desc" => 'описание товара' //только искомое значение
        ...
    ]
]
```
Так же допустима точеная нотация массива как полностью так и частично. Для примера:
```php
[
    //группировка свойств 
    '1.image': '0:'
    '1.amount': 'i:23,52,16'

    'related' => [ 
        //частичная точечная нотация
        'properties.amount': '><:52&75',
        ...
    ],
    'fulltext.ft_desc' => 'описание товара' //только искомое значение
]
```
Если параметр пустой или отсутствует возвращается `Builder` без изменений.

Типы сравнений:  
|в запросе|SQL тип|Описание|
|:-:|:-:|:-|
| = | = | Равно |
| != | <> | Не равно |
| < | < | Меньше |
| <= | <= | Меньше или равно |
| > | > | Больше |
| >= | >= | Больше или равно |
| ~ | LIKE | Находится в искомом значении |
| !~ | NOT LIKE | Исключая находящиеся в искомом значении |
| i | IN | Находится ли значения в пределах набора |
| !i | NOT IN | За исключением значений находящихся наборе |
| >< | BETWEEN| Находятся в диапазоне | 
| !>< | NOT BETWEEN | Исключая диапазон | 
| 0 | NULL | Нулевое значение | 
| !0 | IS_NOT_NULL | Не нулевое значение | 

> значения с типом `LIKE` и `NOT LIKE` оборачиваются в `%`

## Лицензия

Лицензия MIT (MIT).Пожалуйста, смотрите [Файл Лицензии](LICENSE) для получения дополнительной информации.


[ico-license]: https://img.shields.io/badge/license-MIT-brightgreen.svg
[ico-laravel]: https://img.shields.io/badge/Laravel-9+-FF2D20?style=for-the-badge&logo=laravel
[ico-php]: https://img.shields.io/badge/PHP-8+-777BB4?style=for-the-badge&logo=php
[ico-mysql]: https://img.shields.io/badge/mysql-11+-%2300f.svg?&style=for-the-badge&logo=mysql&logoColor=white
